terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
  }
}

provider "azurerm" {
  features {}
}

resource "azurerm_resource_group" "main" {
  name     = var.resource_group_name
  location = var.location
  tags     = var.tags
}

# Storage Accounts
resource "azurerm_storage_account" "source" {
  name                     = var.source_storage_name
  resource_group_name      = azurerm_resource_group.main.name
  location                 = azurerm_resource_group.main.location
  account_tier             = "Standard"
  account_replication_type = "LRS"
  tags                     = var.tags
}

resource "azurerm_storage_container" "source" {
  name                 = "source"
  storage_account_name = azurerm_storage_account.source.name
}

resource "azurerm_storage_account" "destination" {
  name                     = var.destination_storage_name
  resource_group_name      = azurerm_resource_group.main.name
  location                 = azurerm_resource_group.main.location
  account_tier             = "Standard"
  account_replication_type = "LRS"
  tags                     = var.tags
}

resource "azurerm_storage_container" "destination" {
  name                 = "destination"
  storage_account_name = azurerm_storage_account.destination.name
}

# Storage per Function
resource "azurerm_storage_account" "function" {
  name                     = var.function_storage_name
  resource_group_name      = azurerm_resource_group.main.name
  location                 = azurerm_resource_group.main.location
  account_tier             = "Standard"
  account_replication_type = "LRS"
  tags                     = var.tags
}

# Crea archivio ZIP della funzione
data "archive_file" "function_code" {
  type        = "zip"
  source_dir  = path.module
  output_path = "${path.module}/function.zip"
  excludes = [
    "function.zip",
    ".terraform",
    ".terraform.lock.hcl",
    "*.tf",
    "*.tfvars",
    "*.md",
    "logic_app_workflow.json"
  ]
}

# Storage container per il deploy della funzione
resource "azurerm_storage_container" "function_deploy" {
  name                  = "function-releases"
  storage_account_name  = azurerm_storage_account.function.name
  container_access_type = "private"
}

# Upload del codice della funzione
resource "azurerm_storage_blob" "function_code" {
  name                   = "function-${filemd5(data.archive_file.function_code.output_path)}.zip"
  storage_account_name   = azurerm_storage_account.function.name
  storage_container_name = azurerm_storage_container.function_deploy.name
  type                   = "Block"
  source                 = data.archive_file.function_code.output_path
}

# SAS token per il download della funzione
data "azurerm_storage_account_blob_container_sas" "function_sas" {
  connection_string = azurerm_storage_account.function.primary_connection_string
  container_name    = azurerm_storage_container.function_deploy.name
  https_only        = true

  start  = "2024-01-01T00:00:00Z"
  expiry = "2027-12-31T23:59:59Z"

  permissions {
    read   = true
    add    = false
    create = false
    write  = false
    delete = false
    list   = false
  }
}

# Application Insights
resource "azurerm_application_insights" "main" {
  name                = "${var.logic_app_name}-insights"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  application_type    = "other"
  tags                = var.tags
}

# Service Plan per Function
resource "azurerm_service_plan" "main" {
  name                = "${var.function_app_name}-plan"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  os_type             = "Linux"
  sku_name            = "Y1"
  tags                = var.tags
}

# Function App per logging
resource "azurerm_linux_function_app" "main" {
  name                       = var.function_app_name
  resource_group_name        = azurerm_resource_group.main.name
  location                   = azurerm_resource_group.main.location
  service_plan_id            = azurerm_service_plan.main.id
  storage_account_name       = azurerm_storage_account.function.name
  storage_account_access_key = azurerm_storage_account.function.primary_access_key

  site_config {
    application_stack {
      python_version = "3.11"
    }
    application_insights_connection_string = azurerm_application_insights.main.connection_string
  }

  app_settings = {
    FUNCTIONS_WORKER_RUNTIME                   = "python"
    WEBSITE_RUN_FROM_PACKAGE                   = "https://${azurerm_storage_account.function.name}.blob.core.windows.net/${azurerm_storage_container.function_deploy.name}/${azurerm_storage_blob.function_code.name}${data.azurerm_storage_account_blob_container_sas.function_sas.sas}"
    APPINSIGHTS_INSTRUMENTATIONKEY             = azurerm_application_insights.main.instrumentation_key
    APPLICATIONINSIGHTS_CONNECTION_STRING      = azurerm_application_insights.main.connection_string
    ApplicationInsightsAgent_EXTENSION_VERSION = "~3"
  }

  identity {
    type = "SystemAssigned"
  }

  tags = var.tags

  depends_on = [
    azurerm_storage_blob.function_code
  ]
}

# Logic App (Consumption)
resource "azurerm_logic_app_workflow" "main" {
  name                = var.logic_app_name
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location

  identity {
    type = "SystemAssigned"
  }

  tags = var.tags

  depends_on = [
    azurerm_api_connection.azureblob,
    azurerm_linux_function_app.main
  ]
}

# API Connections per Logic App
resource "azurerm_api_connection" "azureblob" {
  name                = "azureblob-connection"
  resource_group_name = azurerm_resource_group.main.name
  managed_api_id      = "/subscriptions/${data.azurerm_client_config.current.subscription_id}/providers/Microsoft.Web/locations/${azurerm_resource_group.main.location}/managedApis/azureblob"
  display_name        = "Azure Blob Connection"

  parameter_values = {
    accountName = azurerm_storage_account.source.name
    accessKey   = azurerm_storage_account.source.primary_access_key
  }
}

data "azurerm_client_config" "current" {}

# Logic App Trigger - When a blob is added or modified
resource "azurerm_logic_app_trigger_recurrence" "check_blobs" {
  name         = "Check_for_new_blobs"
  logic_app_id = azurerm_logic_app_workflow.main.id
  frequency    = "Minute"
  interval     = 1
}

# Note: Il trigger e le action per blob copy devono essere configurate manualmente
# nel portale Azure o tramite Azure CLI dopo il deploy,
# poich√© Terraform non supporta completamente i parametri $connections
# per le API connections nelle Logic Apps.
#
# Oppure utilizzare il workflow JSON di riferimento: logic_app_workflow.json

# Logic App Action - Call Logger Function
resource "azurerm_logic_app_action_http" "call_logger" {
  name         = "Call_Logger_Function"
  logic_app_id = azurerm_logic_app_workflow.main.id
  method       = "POST"
  uri          = "https://${azurerm_linux_function_app.main.default_hostname}/api/logger"

  headers = {
    "Content-Type" = "application/json"
  }

  body = jsonencode({
    blobName             = "@{triggerBody()?['Name']}"
    sourceContainer      = "source"
    destinationContainer = "destination"
    operationTime        = "@{utcNow()}"
  })

  run_after {
    action_name   = "Copy_blob"
    action_result = "Succeeded"
  }

  depends_on = [azurerm_logic_app_action_custom.copy_blob]
}

# Role Assignments
resource "azurerm_role_assignment" "logicapp_source_reader" {
  scope                = azurerm_storage_account.source.id
  role_definition_name = "Storage Blob Data Reader"
  principal_id         = azurerm_logic_app_workflow.main.identity[0].principal_id
}

resource "azurerm_role_assignment" "logicapp_dest_contributor" {
  scope                = azurerm_storage_account.destination.id
  role_definition_name = "Storage Blob Data Contributor"
  principal_id         = azurerm_logic_app_workflow.main.identity[0].principal_id
}

resource "azurerm_role_assignment" "function_contributor" {
  scope                = azurerm_storage_account.source.id
  role_definition_name = "Storage Blob Data Contributor"
  principal_id         = azurerm_linux_function_app.main.identity[0].principal_id
}
